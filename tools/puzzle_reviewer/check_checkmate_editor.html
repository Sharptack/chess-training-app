<!DOCTYPE html>
<html>
<head>
    <title>Check/Checkmate Position Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { margin: 0 0 10px 0; color: #333; }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn:hover { opacity: 0.9; }
        .position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        .position-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .position-card.edited {
            border: 2px solid #ff9800;
        }
        .position-card.edited::before {
            content: '‚úèÔ∏è Edited';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .board-container {
            width: 350px;
            margin: 0 auto 15px auto;
        }
        .position-info {
            margin-bottom: 10px;
        }
        .position-info strong {
            display: inline-block;
            width: 100px;
        }
        .edit-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .edit-form.active {
            display: block;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .stats {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .answer-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .answer-check {
            background: #fff3e0;
            color: #e65100;
        }
        .answer-checkmate {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ôî Check/Checkmate Position Editor</h1>
        <p>Edit and manage check/checkmate training positions</p>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" accept=".json">
        <button class="btn btn-primary" onclick="exportPositions()">üíæ Export All Positions</button>
        <button class="btn btn-secondary" onclick="addNewPosition()">‚ûï Add New Position</button>
        <div class="stats" id="stats" style="display:none; margin-top: 10px;"></div>
    </div>

    <div id="positionsContainer" class="position-grid"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        let positionsData = { positions: [] };
        let boards = {};
        let editedIds = new Set();

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    positionsData = JSON.parse(e.target.result);
                    if (!positionsData.positions) {
                        alert('Invalid file format! Expected {positions: [...]}');
                        return;
                    }
                    renderPositions();
                    updateStats();
                } catch (error) {
                    alert('Error loading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function renderPositions() {
            const container = document.getElementById('positionsContainer');
            container.innerHTML = '';
            boards = {};

            positionsData.positions.forEach((position, index) => {
                const card = createPositionCard(position, index);
                container.appendChild(card);
            });
        }

        function createPositionCard(position, index) {
            const card = document.createElement('div');
            card.className = 'position-card';
            card.id = `position-${position.id}`;
            if (editedIds.has(position.id)) {
                card.classList.add('edited');
            }

            const boardId = `board-${position.id}`;
            const formId = `form-${position.id}`;

            card.innerHTML = `
                <div class="position-info">
                    <strong>ID:</strong> ${position.id}
                    <span class="answer-badge answer-${position.answer}">${position.answer.toUpperCase()}</span>
                </div>
                <div class="board-container">
                    <div id="${boardId}"></div>
                </div>
                <div class="position-info">
                    <strong>Description:</strong> ${position.description}
                </div>
                <div class="position-info" style="font-size: 11px; color: #666;">
                    <strong>FEN:</strong> <code>${position.fen}</code>
                </div>
                <button class="btn btn-secondary" onclick="toggleEditForm('${formId}')">‚úèÔ∏è Edit Position</button>
                <button class="btn btn-danger" onclick="deletePosition(${position.id})">üóëÔ∏è Delete</button>

                <div id="${formId}" class="edit-form">
                    <div class="form-group">
                        <label>FEN Position:</label>
                        <input type="text" id="fen-${position.id}" value="${position.fen}">
                        <button class="btn btn-secondary" style="margin-top: 5px;" onclick="updateBoardPreview(${position.id})">üîÑ Preview FEN</button>
                    </div>
                    <div class="form-group">
                        <label>Answer:</label>
                        <select id="answer-${position.id}">
                            <option value="check" ${position.answer === 'check' ? 'selected' : ''}>Check</option>
                            <option value="checkmate" ${position.answer === 'checkmate' ? 'selected' : ''}>Checkmate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <textarea id="description-${position.id}">${position.description}</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="savePosition(${position.id})">üíæ Save Changes</button>
                    <button class="btn btn-secondary" onclick="toggleEditForm('${formId}')">‚ùå Cancel</button>
                </div>
            `;

            // Initialize chessboard after a slight delay to ensure DOM is ready
            setTimeout(() => {
                const config = {
                    position: position.fen,
                    draggable: false
                };
                boards[position.id] = Chessboard(boardId, config);
            }, 100);

            return card;
        }

        function toggleEditForm(formId) {
            const form = document.getElementById(formId);
            form.classList.toggle('active');
        }

        function updateBoardPreview(id) {
            const fen = document.getElementById(`fen-${id}`).value;
            if (boards[id]) {
                try {
                    boards[id].position(fen);
                } catch (error) {
                    alert('Invalid FEN: ' + error.message);
                }
            }
        }

        function savePosition(id) {
            const position = positionsData.positions.find(p => p.id === id);
            if (!position) return;

            position.fen = document.getElementById(`fen-${id}`).value;
            position.answer = document.getElementById(`answer-${id}`).value;
            position.description = document.getElementById(`description-${id}`).value;

            editedIds.add(id);

            // Update the card display
            renderPositions();
            updateStats();

            alert(`Position ${id} saved!`);
        }

        function deletePosition(id) {
            if (!confirm(`Delete position ${id}?`)) return;

            positionsData.positions = positionsData.positions.filter(p => p.id !== id);
            editedIds.delete(id);
            renderPositions();
            updateStats();
        }

        function addNewPosition() {
            const newId = Math.max(...positionsData.positions.map(p => p.id), 0) + 1;
            const newPosition = {
                id: newId,
                fen: "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
                answer: "check",
                description: "New position - edit this description"
            };

            positionsData.positions.push(newPosition);
            editedIds.add(newId);
            renderPositions();
            updateStats();

            // Scroll to new position
            setTimeout(() => {
                document.getElementById(`position-${newId}`).scrollIntoView({ behavior: 'smooth' });
            }, 200);
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const total = positionsData.positions.length;
            const checkCount = positionsData.positions.filter(p => p.answer === 'check').length;
            const checkmateCount = positionsData.positions.filter(p => p.answer === 'checkmate').length;
            const editedCount = editedIds.size;

            stats.style.display = 'block';
            stats.innerHTML = `
                <strong>üìä Stats:</strong>
                ${total} total positions |
                ${checkCount} check |
                ${checkmateCount} checkmate |
                ${editedCount} edited
            `;
        }

        function exportPositions() {
            if (positionsData.positions.length === 0) {
                alert('No positions to export!');
                return;
            }

            const dataStr = JSON.stringify(positionsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'check_checkmate_positions_edited.json';
            link.click();
            URL.revokeObjectURL(url);

            alert('Positions exported! ' + (editedIds.size > 0 ? `(${editedIds.size} edited)` : ''));
        }
    </script>
</body>
</html>
